(function registerIlBronzaDatatablesSummary() {
    if (!$.fn.dataTable || !$.fn.dataTable.Api) {
        setTimeout(registerIlBronzaDatatablesSummary, 100);
        return;
    }

    /* ===============================
     *  API helpers (unchanged)
     * =============================== */
    $.fn.dataTable.Api.register('hasSummary()', function (table = null) {
        return this.getDataAttribute('summary', table);
    });

    $.fn.dataTable.Api.register('hasSummaryActive()', function () {
        const table = this.table().node();
        return table && table.__summaryActive === true;
    });

    $.fn.dataTable.Api.register('toggleShowSelected()', function (table = null) {
        if (!table) table = this.getTableElement();
        if (typeof table.data('showSelected') === 'undefined')
            return table.data('showSelected', true);
        table.data('showSelected', !table.data('showSelected'));
    });

    window.transformDataBySummaryExistence = function (tableId, summary, json) {
        return json.data;
    };

    /* ===============================
     *  Value extraction
     * =============================== */

    function extractNumericValue(raw) {
        if (raw === null || typeof raw === 'undefined') return null;

        if (Array.isArray(raw)) {
            // convention: [id, value]
            if (raw.length > 1) {
                const v = parseFloat(raw[1]);
                return isNaN(v) ? null : v;
            }
        
            const v = parseFloat(raw[0]);
            return isNaN(v) ? null : v;
        }
        
        if (typeof raw === 'number') {
            return isNaN(raw) ? null : raw;
        }

        if (typeof raw === 'string') {
            const v = parseFloat(raw);
            return isNaN(v) ? null : v;
        }

        return null;
    }

    /* ===============================
     *  Aggregators
     * =============================== */

    const aggregators = {
        sum(values) {
            return values.reduce((acc, v) => acc + v, 0);
        },

        average(values) {
            if (!values.length) return 0;
            return values.reduce((acc, v) => acc + v, 0) / values.length;
        },

        distinct(values) {
            const map = {};
            values.forEach(v => {
                const key = String(v);
                map[key] = (map[key] || 0) + 1;
            });
            return map;
        },
        countDistinct(values) {
            const set = new Set(values.map(v => String(v)));
            return set.size;
        }
    };

    /* ===============================
     *  Formatters
     * =============================== */

    const formatters = {
        number(value) {
            return Math.round((value + Number.EPSILON) * 100) / 100;
        },

        minutes(value) {
            const hours = Math.floor(value / 60) + 'h';
            const minutes = Math.floor(value % 60) + "'";
            return hours + ' ' + minutes;
        },

        distinct(map) {
            return Object.keys(map)
                .map(k => k + ': ' + map[k])
                .join('<br />');
        }
    };

    /* ===============================
     *  Summary dispatcher
     * =============================== */

    const summaryHandlers = {
        sum: {
            aggregate: 'sum',
            format: 'number'
        },
        average: {
            aggregate: 'average',
            format: 'number'
        },
        sumMinutes: {
            aggregate: 'sum',
            format: 'minutes'
        },
        sumMinutesArray: {
            aggregate: 'sum',
            format: 'minutes'
        },
        sumSecondsArray: {
            aggregate: 'sum',
            format: 'minutes',
            post(value) {
                return value / 60;
            }
        },
        sumSeconds: {
            aggregate: 'sum',
            format: 'minutes',
            post(value) {
                return value / 60;
            }
        },
        distinct: {
            aggregate: 'distinct',
            format: 'distinct'
        },
        countDistinct: {
            aggregate: 'countDistinct',
            format: 'number'
        }
    };

    /* ===============================
     *  Pure calculation helpers
     * =============================== */

    function calculateSummaryValues(rows, columnIndex, handler, useSearchApplied = false)
    {
        const values = [];

        rows.every(function (rowIdx) {
            const raw = useSearchApplied
                ? this.cell(rowIdx, columnIndex, { search: 'applied' }).data()
                : this.cell(rowIdx, columnIndex).data();

            const numeric = extractNumericValue(raw);
            if (numeric !== null) values.push(numeric);
        });

        let result = aggregators[handler.aggregate](values);
        if (handler.post)
            result = handler.post(result);

        return result;
    }

    function renderSummaryValue($target, value, handler)
    {
        const formatted = formatters[handler.format](value);

        $target
            .html(formatted)
            .addClass('summary-updated');

        setTimeout(function () {
            $target.removeClass('summary-updated');
        }, 500);
    }

    /* ===============================
     *  Main summary engine
     * =============================== */

    window.populateFilteredColumnValues = function (api, tableId = null) {
        if (!api.hasSummaryActive()) {
            return;
        }
        // React ONLY when summary is active
        if (!tableId) tableId = api.table().node().id;

        let filterRowsOptions = {};
        if (window[tableId + 'FilteredSelected'])
            filterRowsOptions = { selected: true };

        const summaryRows = api.rows({ selected: true }); // for 'summary' row
        const inlineRows = api.rows(); // for 'inlinesearchsummary' row

        $('#' + tableId)
            .find('thead tr.columns th')
            .each(function () {
                const summaryType = $(this).find('input').data('summary');
                if (!summaryType || !summaryHandlers[summaryType]) return;

                const columnIndex = $(this).data('column');

                // inline search summary (all filtered rows)
                const inlineTarget = $('#' + tableId + ' .inlinesearchsummary')
                    .find('.summary' + columnIndex);

                // selected-only summary
                const summaryTarget = $('#' + tableId + ' tr.summary')
                    .find('.summary' + columnIndex);

                const handler = summaryHandlers[summaryType];

                const inlineResult = calculateSummaryValues(
                    inlineRows,
                    columnIndex,
                    handler,
                    true
                );

                renderSummaryValue(inlineTarget, inlineResult, handler);

                const selectedResult = calculateSummaryValues(
                    summaryRows,
                    columnIndex,
                    handler,
                    false
                );

                renderSummaryValue(summaryTarget, selectedResult, handler);
            });
    };

    /* ===============================
     *  Recalculate summary on row selection changes
     * =============================== */

    $(document).on('select.dt deselect.dt', function (e, dt) {
        if (!dt || !dt.hasSummaryActive || !dt.hasSummaryActive())
            return;

        // Lightweight recalculation: update summary without triggering a full draw
        window.populateFilteredColumnValues(dt);
    });
})();