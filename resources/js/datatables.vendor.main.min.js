(function registerDrawCallbackWhenReady()
{
    if ($.fn.dataTable && $.fn.dataTable.Api)
    {
        $.fn.dataTable.Api.register('_drawCallback()', function ()
        {
            if (this.hasSummaryActive())
            {
                window.populateFilteredColumnValues(this);
            }

            window.__showTableDuplicates(this);

            // this.columns.adjust();
        });

        $.fn.dataTable.Api.register('column().getTableNode()', function ()
        {
            if($(this.headerFilters()).parents('.dt-scroll-head').length > 0)
                return $(this.headerFilters()).parents('.dt-scroll-head').siblings('.dt-scroll-body').find('table');

            return $(this.headerFilters()).parents('table');
        });

        $.fn.dataTable.Api.register('column().getDataTable()', function ()
        {
            return this.getTableNode().DataTable();
        });

        $.fn.dataTable.Api.register('column().launchDraw()', function ()
        {
            let column = this;

            let tableNode = column.getDataTable();

            clearTimeout(window.searchTimeout);

            let timeInterval = (tableNode.settings()[0].searchDelay) ? tableNode.settings()[0].searchDelay : 350;

            window.searchTimeout = setTimeout(function ()
            {
                column.draw();
            }, timeInterval);
        });


        $.fn.dataTable.Api.register('column().headerFilters()', function ()
        {
            // indice colonna
            let index = this.index();

            return ($(this.table().header())
                .find('tr.columns th[data-dt-column="' + index + '"]'));
        });

        $.fn.dataTable.Api.register('getTableElement()', function ()
        {
            if($(this.table().container()).find('.dt-scroll-body table').length > 0)
                return $(this.table().container()).find('.dt-scroll-body table');

            return $(this.table().container()).children('table').first();
        });

        $.fn.dataTable.Api.register('column().getHeaderData()', function (dataName)
        {
            let data = $(this.headerFilters()).data(dataName);

            if (typeof data === 'undefined')
                return false;

            return data;
        });

        $.fn.dataTable.Api.register('getDataAttribute()', function (dataName, table = null)
        {
            if (!table)
                table = this.getTableElement();

            if (typeof table.data(dataName) === 'undefined')
                return false;

            return table.data(dataName);
        });
    } else {
        // Riprova dopo un attimo
        setTimeout(registerDrawCallbackWhenReady, 100);
    }
})();

window.addParameterToURL = function(url, paramName, paramValue)
{
    url += (url.split('?')[1] ? '&':'?') + paramName + '=' + paramValue;

    return url;
}

window.reloadDatatable = function(table)
{
    table.ajax.reload(function ()
    {
        // window.__showTableDuplicates(table);
    });
}

//TODO TODO TODO SISTEMARE
//questo è per filtrare da parametri in get.... fa un po' schifo ma funziona
window.dtFilterUrlParameters = function(fields)
{
    for(const field of fields)
    {
        $('table.datatable').each(function()
        {
            $(this).find('th.' + field + ' input').keyup();
        });
    }
}
//questo è per filtrare da parametri in get.... fa un po' schifo ma funziona
//FINE TODO TODO TODO SISTEMARE

$(document).ready(function($)
{
    // Track last navigation source (keyboard vs pointer)
    window.__dtLastNav = { type: null, ts: 0, key: null };

    $(document).on('keydown', function (e) {
        const keys = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Tab','Enter'];
        if (keys.includes(e.key)) {
            window.__dtLastNav = { type: 'keyboard', ts: Date.now(), key: e.key };
        }
    });

    $(document).on('mousedown pointerdown touchstart', function () {
        window.__dtLastNav = { type: 'pointer', ts: Date.now(), key: null };
    });

    $('body').on('mouseenter', '.dt-scroll-body table.wannabedatatable', function (e)
    {
        if (! $(this).data('adjusted'))
        {
            let table = $(this).DataTable();

            table.columns.adjust().draw();

            $(this).data('adjusted', true);
        }
    });

    $('body').on('click', '.ib-dt-alert-cell', function (e)
    {
        UIkit.modal.dialog($(this).attr('title'));
    });

    $('.wannabedatatable').each(function()
    {
        let tableId = $(this).attr('id');
        let columnDefs = window[tableId + 'columnDefs'];
        let rowReorder = window[tableId + 'rowReorder'];
        let options = window[tableId + 'options'];
        let buttons = window[tableId + 'buttons'];

        let settings = {
            processing: true,
            orderCellsTop: true,
            searchDelay: 450,
            lengthMenu: [[10, 25, 50, 100, 250, 500, -1], [10, 25, 50, 100, 250, 500, "All"]],
            columnDefs : columnDefs,
            rowReorder : rowReorder,
            buttons: {
                dom: {
                    button: {
                        className: 'uk-button uk-button-small'
                    }
                },
                buttons: buttons
            },
            initComplete: function ()
            {
                if (typeof $('#' + tableId).data('sticky') !== 'undefined')
                    UIkit.sticky($('#' + tableId + '_wrapper').find('.' + $('#' + tableId).data('sticky')), {bottom: true});

                // this.api().applyTableFilters();

                if(typeof window[tableId + 'options'].captionText !== 'undefined')
                    $('#' + tableId + '_wrapper .tablecaption').html(window[tableId + 'options'].captionText);

                $('#' + tableId + '_wrapper .dataTables_length select').addClass('uk-select');
                $('#' + tableId + '_filter input').addClass('uk-input').attr('placeholder', window[tableId + 'options'].language.searchPlaceholder);




                //TODO TODO TODO SISTEMARE
                //questo è per filtrare da parametri in get.... fa un po' schifo ma funziona
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);

                var entries = urlParams.entries();
                var fields = [];

                for(var entry of entries)
                {
                    var pieces = entry[0].split('-');

                    if(pieces[0] == 'dtFilter')
                    {
                        fields.push(pieces[1]);

                        $('#' + tableId).find('th.' + pieces[1] + ' input').val(entry[1]);
                    }
                }

                setTimeout(dtFilterUrlParameters, 2, fields);
                //questo è per filtrare da parametri in get.... fa un po' schifo ma funziona
                //FINE TODO TODO TODO SISTEMARE
            }
        };

        jQuery.extend(settings, options);

        const userDrawCallback = settings.drawCallback;

        settings.drawCallback = function (settings) {
            // 1) callback del chiamante (quella che hai visto nel log)
            if (typeof userDrawCallback === 'function') {
                userDrawCallback.call(this, settings);
            }

            // 2) callback “core” registrata su Api
            this.api()._drawCallback();
        };

        window['table' + tableId] = $(this).DataTable(settings)
            .on('key-blur', function ( e, datatable, cell ) {
                $(cell.node()).find('input').blur();
                $(cell.node()).find('select').blur();
            }).on('preDraw', function () {
                startTime = new Date().getTime();
            }).on('row-reorder', function (e, diff, edit)
            {
                let tableNode = $(e.target);
                let table = tableNode.DataTable({retrieve: true});
                let rowIdColumnIndex = tableNode.data('rowid');

                if(typeof rowIdColumnIndex == 'undefined')
                {
                    alert('Manca data-rowid sulla tabella');
                    // return false;
                }

                let storeSortingUrl = tableNode.data('storemasssortingurl');

                if(typeof storeSortingUrl == 'undefined')
                {
                    console.log('Manca data-sortingurl sulla tabella');
                    // return false;
                }

                window.changedSorting = true;

                var sortingData = new Object();

                for ( var i=0, ien=diff.length ; i<ien ; i++ )
                {
                    var rowData = table.row( diff[i].node ).data();

                    var rowId = rowData[rowIdColumnIndex];
                    var newPosition = diff[i].newData;

                    sortingData[rowId] = newPosition;
                }

                if(storeSortingUrl)
                    $.ajax({
                        url: storeSortingUrl,
                        type: 'POST',
                        data: {
                            indexes : sortingData
                        },
                        error: function(response, message, asd)
                        {
                            alert('Error');
                        },
                        success: function(response)
                        {
                            window.addSuccessNotification('Reorder done');
                        }
                    });
            })
            .on('key-focus', function ( e, datatable, cell ) {

                const rowIdx = cell.index().row;
                const rowNode = datatable.row(rowIdx).node();

                if (!rowNode) return;

// rimuovi il focus dalle altre righe della stessa tabella
                $(datatable.table().body())
                    .find('tr.ib-row-focused')
                    .not(rowNode)
                    .removeClass('ib-row-focused');

// toggle sulla riga corrente
                rowNode.classList.toggle('ib-row-focused');

                setTimeout(function () {

                    // 1) select-all ONLY if we arrived here via keyboard navigation very recently
                    const nav = window.__dtLastNav || {};
                    if (nav.type !== 'keyboard') return;
                    if (nav.ts && (Date.now() - nav.ts > 600)) return; // stale: ignore

                    const $node = $(cell.node());
                    const $field = $node.find('input, textarea').first();

                    if ($field.length) {
                        const el = $field[0];

                        // 2) don't override if user is already editing that same field
                        if (document.activeElement === el) return;

                        // 3) avoid types where select() is pointless / annoying
                        const type = String($field.attr('type') || '').toLowerCase();
                        if (['checkbox', 'radio', 'file', 'button', 'submit'].includes(type)) {
                            $field.trigger('focus');
                            return;
                        }

                        el.focus();

                        if (typeof el.select === 'function') {
                            el.select();
                        }

                        return;
                    }

                    // select: just focus
                    const $select = $node.find('select').first();
                    if ($select.length) $select.trigger('focus');

                }, 50);

            });


        new $.fn.dataTable.Buttons( window['table' + tableId], {
            buttons: []
        } );

        window['table' + tableId].buttons( 1, null ).container().appendTo(
            window['table' + tableId].table().container()
        );

    });


    /**
     * gestione dell'ordinamento delle colonne START
     */
    function toggle(dir) { return dir === 'asc' ? 'desc' : 'asc'; }

    function toggleSort(table, colIndex, shiftKey)
    {
        const cur = table.order();                 // es: [[0,'asc'],[2,'desc']]

        if (shiftKey) {
            // ---- SHIFT + click: mantieni il resto ----
            const others = cur.filter(([i]) => i !== colIndex);
            const found  = cur.find(([i]) => i === colIndex);

            let next;
            if (!found) {
                // non c'era: aggiungila in coda come priorità più bassa
                next = [...cur, [colIndex, 'asc']];
            } else {
                // c'era: toggla solo la sua direzione, mantieni le altre
                next = [...others, [colIndex, toggle(found[1])]];
            }
            table.order(next).draw();

        } else {
            // ---- Click normale: SOLO questa colonna ----
            const found = cur.find(([i]) => i === colIndex);
            const dir = found ? toggle(found[1]) : 'asc';
            table.order([[colIndex, dir]]).draw();
        }
    }


    $('.filterfunctions .changesorting').click(function (e)
    {
        e.stopPropagation();

        let th = $(this).closest('th');
        let colIndex = $(th).data('column');
        let datatable = window.__getDataTable(this);

        toggleSort(datatable, colIndex, e.shiftKey);
    });

    /**
     *
     * gestione dell'ordinamento delle colonne END
     */






    $('body').on( 'mouseenter', '.uk-text-truncate', function(){
        var $this = $(this);

        if(this.offsetWidth < this.scrollWidth && !$this.attr('title')){
            $this.attr('title', $this.text());
            UIkit.tooltip($this, {title: $this.text()}).show();
        }
    });



});   
