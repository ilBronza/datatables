(function registerIlBronzaDatatablesUtilities() {
    if ($.fn.dataTable && $.fn.dataTable.Api) {
        $.fn.dataTable.Api.register('column().getLabel()', function ()
        {
            return this.getHeaderData('label');
        });



        jQuery(document).ready(function()
        {
            window.decodeHTMLEntities = function(text)
            {
                var entities = [
                    ['amp', '&'],
                    ['apos', '\''],
                    ['#x27', '\''],
                    ['#x2F', '/'],
                    ['#39', '\''],
                    ['#47', '/'],
                    ['lt', '<'],
                    ['gt', '>'],
                    ['nbsp', ' '],
                    ['quot', '"']
                ];

                for (var i = 0, max = entities.length; i < max; ++i)
                    text = text.replace(new RegExp('&'+entities[i][0]+';', 'g'), entities[i][1]);

                return text;
            }

            window.getContentByCell = function(cell)
            {
                let cellTargert = window.__getCell(cell);
                let cellData = cellTargert.data();

                // var content = $(cell).closest('.client').find('a').html();
                var content;

                if(cellData.hasOwnProperty(1))
                    return cellData[1];

                return cellData[0];
            }

            window.filterRowsByCell = function(cell, set)
            {
                let content = window.getContentByCell(cell);

            // if (set) var content = $(cell).closest('.clientId').find('a').html();else var content = '';
                if(! set)
                    content = '';

                let th = window.__getTH(cell);

                th.find('input').val(window.decodeHTMLEntities(content)).change();
            }

            window.checkRowsByRowsCell = function(rows, value)
            {
                var changed = 0;

                rows.every(function()
                {
                    changed ++;

                    if(value)
                        this.select();
                    else
                        this.deselect();
                });

                if(value == true)
                    window.addSuccessNotification('aggiunte ' + changed + ' commesse alla selezione', 0.2);
                else
                    window.addWarningNotification('rimosse ' + changed + ' commesse dalla selezione', 0.2);
            }

            window.getRowsIndexesByCell = function(table, cell, justVisible = false)
            {
                let cellTargert = window.__getCell(cell);
                let cellData = cellTargert.data();

                var content = (cellData && cellData.hasOwnProperty(1))
                    ? cellData[1]
                    : cellData[0];

                var tdIndex = $(cell).closest('td').index() + 1;
                var colIndex = $(cell).parents('table.dataTable').find('thead tr.columns th:nth-child(' + tdIndex + ')').data('column');

                // var indexes;

                var indexes = (justVisible)
                    ? table.rows({ search: 'applied', page: 'current' })
                    : table.rows();

                //
                // if(justVisible)
                //     indexes = table.rows({ search: 'applied', page: 'current' });
                //
                // else
                //     indexes = table.rows();

                return indexes.eq( 0 ).filter( function (rowIdx) {

                    // var current = $(table.cell( rowIdx, colIndex ).node()).find('a').html();
                    // var current = $(table.cell(rowIdx, colIndex).node()).children().first().text();

                    var currentData = table.cell(rowIdx, colIndex).data();
                    var current = (currentData && currentData.hasOwnProperty(1))
                        ? currentData[1]
                        : currentData[0];

                    return (current === content) ? true : false;
                } );

                // return indexes;
            }

            window.getRowsByCell = function (cell, justVisible = false)
            {
                var table = $(cell).parents('table.dataTable').DataTable();
                var indexes = window.getRowsIndexesByCell(table, cell, justVisible);

                return table.rows( indexes );
                    // .nodes()
                    // .to$();
            }

            window.checkVisibleRowsByCell = function(cell, value)
            {
                var rows = window.getRowsByCell(cell, true);

                window.checkRowsByRowsCell(rows, value);
            }

            window.checkRowsByCell = function(cell, value)
            {
                var rows = window.getRowsByCell(cell);

                window.checkRowsByRowsCell(rows, value);
            }

            window.replaceLinkByCell = function(target, value)
            {
                let cell = window.__getCell(target);
                let cellData = cell.data();

                var href = $(target).closest('a').attr('href');

                href = href.replace(window.replace_model_id_string, cellData[0]);

                console.log(href);

                $(target).attr('href', href);
            }

            $('body').on('mouseleave', '.ibop', function()
            {
                $(this).find('div.fieldoperations').remove();
            });

            $('body').on('click', '.ibfieldoperationcheckVisible', function()
            {
                window.checkVisibleRowsByCell(this, true);
            });

            $('body').on('click', '.ibfieldoperationcheckAll', function()
            {
                window.checkRowsByCell(this, true);
            });

            $('body').on('click', '.ibfieldoperationban', function()
            {
                window.checkRowsByCell(this, false);
            });

            $('body').on('mouseover', '.ibfieldoperationlink', function()
            {
                console.log('hover');
                window.replaceLinkByCell(this, false);
            });

            $('body').on('click', '.ibfieldoperationsearch', function()
            {
                window.filterRowsByCell(this, true);
            });

            $('body').on('click', '.ibfieldoperationclose', function()
            {
                $(this).find('div').remove();
                window.filterRowsByCell(this, false);
            });

            $('body').on('click', '.ibfieldoperationfilteredTable', function()
            {
                let cell = window.__getCell(this);
                let cellData = cell.data();

                var htmlTable = $(this).parents('.dataTable');
                var table = htmlTable.DataTable();
                let tableId = htmlTable.attr('id');

                let td = $(this).closest('td');

                var tdIndex = td.index() + 1;

                // var th = $(this).parents('.dataTable').find('thead tr th:nth-child(' + tdIndex + ')');
                var th = window.__getTH(this);

                let htmlClass = th.data('camelname');

                let filteringIndex = $(th).data('column');
                // var filteringValue = td.text();

                var filteringValue;

                if (cellData.hasOwnProperty(1))
                    filteringValue = cellData[1];
                else
                    filteringValue = cellData[0];

                if ($('#modal-' + tableId).length == 0)
                    $('body').append('<div id="modal-' + tableId + '" uk-modal><div class="uk-modal-dialog uk-width-1-1 uk-height-1-1"><iframe name="' + Date.now() + '" class="uk-width-1-1 uk-height-1-1" src="' + table.ajax.url() + '&filteringIndex=' + filteringIndex + '&filteringValue=' + filteringValue + '&iframed=true&justTable=true" uk-video></iframe></div></div>');

                UIkit.modal($('#modal-' + tableId)).show();

                var iframe = $('#modal-' + tableId + ' iframe').contents();

                var input = iframe.find('thead th.' + htmlClass + ' input');

                iframe.find('thead').find('input').each(function ()
                {
                    if ($(this).val())
                    {
                        $(this).val('');
                        $(this).click();
                    }
                });

                input.val(filteringValue).change();

                // const iframeItem = $('#modal-' + tableId + ' iframe')[0];

                // iframeItem.addEventListener('load', () => {
                //     alert('loaddato');
                // });
                //
                // setTimeout(function()
                // {
                if(typeof $('#modal-' + tableId + ' iframe')[0].contentWindow.filterByUrlParamsTEST === 'function')
                    $('#modal-' + tableId + ' iframe')[0].contentWindow.filterByUrlParamsTEST(filteringIndex, filteringValue);
                // }, 1000);



                    //
                    //
                    //
                    // const iframeItem = $('#modal-' + tableId + ' iframe')[0];
                    //
                    // console.log(iframeItem);
                    //
                    // iframeItem.addEventListener('load', () => {
                    //
                    //     setTimeout(function()
                    //     {
                    //         var iframe = $('#modal-' + tableId + ' iframe').contents();
                    //
                    //         iframe.find('.sectionheader th').each(function () {
                    //
                    //
                    //             console.log(($(this).val()));
                    //
                    //             if ($(this).val()) {
                    //                 $(this).val('');
                    //
                    //                 setTimeout(function()
                    //                 {
                    //                     $(this).trigger('blur');
                    //                     $(this).trigger('change');
                    //                     $(this).trigger('keyup');
                    //                 }, 500);
                    //             }
                    //
                    //             console.log("dopo: " + ($(this).val()));
                    //         });
                    //     }, 2000);
                    //
                    // });

            });


            function getSearchParameters() {
                var prmstr = window.location.search.substr(1);
                return prmstr != null && prmstr != "" ? transformToAssocArray(prmstr) : {};
            }

            function transformToAssocArray( prmstr ) {
                var params = {};
                var prmarr = prmstr.split("&");
                for ( var i = 0; i < prmarr.length; i++) {
                    var tmparr = prmarr[i].split("=");
                    params[tmparr[0]] = tmparr[1];
                }
                return params;
            }


            window.filterByUrlParamsTEST = function (filteringIndex, filteringValue)
            {
                $('.dataTable').DataTable().search('').columns().search('').draw();

                setTimeout(function()
                {
                    $('.dataTable').find('thead th[data-column=' + filteringIndex + '] input').val(filteringValue);
                    $('.dataTable').find('thead th[data-column=' + filteringIndex + '] input').val(decodeURI(filteringValue)).keyup();
                }, 1500);

                console.log('filtro applicato dalla url: ' + filteringIndex + ' = ' + filteringValue);
            }

            $(document).on('init.dt', function ( e, settings )
            {
                var params = getSearchParameters();

                if((typeof params.filteringIndex !== 'undefined')&&(typeof params.filteringValue !== 'undefined'))
                    window.filterByUrlParamsTEST(params.filteringIndex, params.filteringValue);

                var api = new $.fn.dataTable.Api( settings );

                window.__showTableDuplicates(api);
            });

        });
    } else {
        // Riprova dopo un attimo
        setTimeout(registerIlBronzaDatatablesUtilities, 100);
    }
})();