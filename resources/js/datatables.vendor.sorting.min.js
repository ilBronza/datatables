(function registerIlBronzaDatatablesSorting() {
    if ($.fn.dataTable && $.fn.dataTable.Api) {

        $(document).ready(function($)
        {
            // START SCRIPTS PER LE RICERCHE SU CAMPI
            /* Create an array with the values of all the input boxes in a column */
            $.fn.dataTable.ext.order['dom-text'] = function  ( settings, col )
            {
                return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
                    return $('input', td).val();
                } );
            }

            /* Create an array with the values of all the input boxes in a column, parsed as numbers */
            $.fn.dataTable.ext.order['dom-text-numeric'] = function  ( settings, col )
            {
                return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
                    return $('input', td).val() * 1;
                } );
            }
             
            /* Create an array with the values of all the select options in a column */
            $.fn.dataTable.ext.order['dom-select'] = function  ( settings, col )
            {
                return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
                    return $('select', td).val();
                } );
            }
             
            $.fn.dataTable.ext.order['mystring-asc'] = function  ( settings, col )
            {
                return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i )
                {
                    let value = $(td).html();

                    if(value == '')
                        value = 'zzzzz';

                    return value;
                } );
            }

            $.fn.dataTable.ext.order['mynumber-asc'] = function ( settings, col )
            {
                alert('Cancellare questa cosa, il nuovo datatables non lo vuole piÃ¹');

                // const api = this.api();
                //
                // return api.column(col, { order: 'index' }).nodes().map(function (td) {
                //
                //     // ðŸ”’ usa SOLO il dato logico (JSON), mai il DOM
                //     let data = api.cell(td).data();
                //
                //     console.log('data for sorting:', data);
                //
                //     // caso 1: numero puro
                //     if (typeof data === 'number')
                //         return data;
                //
                //     // caso 2: array [raw, display]
                //     if (Array.isArray(data)) {
                //         let raw = data[0];
                //         let n = Number(raw);
                //         if (!Number.isNaN(n))
                //         {
                //             console.log('rielaborato:', n);
                //
                //             return n;
                //         }
                //     }
                //
                //     // caso 3: oggetto { raw, display }
                //     if (typeof data === 'object' && data !== null && data.raw !== undefined) {
                //         let n = Number(data.raw);
                //         if (!Number.isNaN(n))
                //         {
                //             console.log('da oggetto:', n);
                //
                //             return n;
                //         }
                //     }
                //
                //     console.log('ritorno :', Number.MAX_SAFE_INTEGER);
                //
                //     // fallback: null / non numerico â†’ in fondo
                //     return Number.MAX_SAFE_INTEGER;
                // });
            }

            $.fn.dataTable.ext.order['mynumber-desc'] = function  ( settings, col )
            {
                return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i )
                {
                    let value = $(td).html();

                    if(value == '')
                        value = -9999999999999;

                    return value;
                } );
            }

            $.fn.dataTable.ext.order['mydate-asc'] = function  ( settings, col )
            {
                return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i )
                {
                    let value = $(td).html();

                    if(value == '')
                        value = '4021-05-28 10:27:00';

                    return value;
                } );
            }

            jQuery.fn.dataTableExt.order['test-asc'] = function(x,y)
            {
                var retVal;
                x = $.trim(x);
                y = $.trim(y);

                if (x==y) retVal= 0;
                else if (x == "" || x == " ") retVal= 1;
                else if (y == "" || y == " ") retVal= -1;
                else if (x > y) retVal= 1;
                else retVal = -1; // <- this was missing in version 1

                return retVal;
            }

            /* Create an array with the values of all the checkboxes in a column */
            $.fn.dataTable.ext.order['dom-checkbox'] = function  ( settings, col )
            {
                return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i )
                {
                    return $('input', td).prop('checked') ? '1' : '0';
                });
            }    
        });
    } else {
        // Riprova dopo un attimo
        setTimeout(registerIlBronzaDatatablesSorting, 100);
    }
})();