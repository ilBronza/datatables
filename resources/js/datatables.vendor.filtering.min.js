(function ilBronzaDatatablesFiltering() {
    if (!$.fn.dataTable || !$.fn.dataTable.Api) {
        setTimeout(ilBronzaDatatablesFiltering, 100);
        return;
    }

    $.fn.dataTable.Api.register('column().escapeRegex()', function (val) {
        if (!val) return '';
        return String(val).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    });

    $.fn.dataTable.Api.register('column().getHeaderTh()', function () {
        return $(this.header()).closest('.sectionheader').find('.columns th[data-column="' + this.index() + '"]');
    });

    $.fn.dataTable.Api.register('column().getFooterTh()', function () {
        return $(this.footer()).closest('.sectionfooter').find('.columns th[data-column="' + this.index() + '"]');
    });

    $.fn.dataTable.Api.register('column().parseValueByType()', function (value, end = false) {
        let th = this.getHeaderTh();

        let type = th.data('filter-type');

        if(type == 'text')
            return value;

        if(type == 'date')
        {
            if(! end)
                return new Date(value).getTime() / 1000;

            let d = new Date(value);
            d.setHours(23, 59, 59, 999);
            return Math.floor(d.getTime() / 1000);
        }

        alert('tipo mancante ' + type);

        return value;
    });


    $.fn.dataTable.Api.register('column().getThValue()', function (th) {
        var $input = th.find('input, select, textarea').first();
        let value = $input.length ? $input.val() : '';

        return this.parseValueByType(value);
    });

    $.fn.dataTable.Api.register('column().getThRangeValue()', function (th) {

        let min = this.parseValueByType(
            th.find('input[id$="start"]').val()
        );

        let max = this.parseValueByType(
            th.find('input[id$="end"]').val(),
            true
        );

        return {min, max};
    });

    $.fn.dataTable.Api.register('column().getHeaderSingleValue()', function () {
        let th = this.getHeaderTh();

        return this.getThValue(th);
    });

    $.fn.dataTable.Api.register('column().getFooterSingleValue()', function () {
        let th = this.getFooterTh();

        return this.getThValue(th);
    });

    $.fn.dataTable.Api.register('column().getHeaderRangeValues()', function(type) {
        let th = this.getHeaderTh();

        return this.getThRangeValue(th);
    });

    $.fn.dataTable.Api.register('column().getFooterRangeValues()', function(type) {
        let th = this.getFooterTh();

        return this.getThRangeValue(th);
    });




    $.fn.dataTable.Api.register('column().applyCombinedSearch()', function (includeVal, excludeVal) {
        var rawInc = (includeVal || '');
        var rawExc = (excludeVal || '');

        // Support OR syntax with `|` (e.g. "foo|bar")
        var inc = '';
        if (rawInc && rawInc.indexOf('|') !== -1) {
            var incParts = rawInc.split('|').map(function (p) { return (p || '').trim(); }).filter(function (p) { return p.length; });
            if (incParts.length) {
                inc = '(?:' + incParts.map(this.escapeRegex).join('|') + ')';
            }
        } else {
            inc = this.escapeRegex(rawInc);
        }

        var exc = '';
        if (rawExc && rawExc.indexOf('|') !== -1) {
            var excParts = rawExc.split('|').map(function (p) { return (p || '').trim(); }).filter(function (p) { return p.length; });
            if (excParts.length) {
                exc = '(?:' + excParts.map(this.escapeRegex).join('|') + ')';
            }
        } else {
            exc = this.escapeRegex(rawExc);
        }

        var lookaheads = [];
        if (inc) lookaheads.push('(?=.*' + inc + ')');
        if (exc) lookaheads.push('(?!.*' + exc + ')');

        var pattern = lookaheads.length ? '^' + lookaheads.join('') + '.*$' : '';
        this.search(pattern, !!pattern, false);
    });

    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex, rowData)
    {
        let key = settings.nTable.getAttribute('id') + '_rangeFilters';

        if(! window[key])
            return true;

        let result = true;

        for (let colIndex of Object.keys(window[key])) {

            var value = rowData[colIndex];

            let hr = window[key][colIndex].header;

            if(hr)
            {
                if(! isNaN( hr.min ) && value < hr.min )
                {
                    result = false;
                    break;
                }

                if(! isNaN( hr.max ) && value > hr.max )
                {
                    result = false;

                    break;
                }
            }

            hr = window[key][colIndex].footer;

            if(hr)
            {
                if(! isNaN( hr.min ) && value >= hr.min )
                {
                    if((isNaN( hr.max ))||(value <= hr.max))
                    {
                        result = false;
                        break;
                    }
                }

                if(! isNaN( hr.max ) && value <= hr.max )
                {
                    if((isNaN( hr.min ))||(value >= hr.min))
                    {
                        result = false;

                        break;
                    }
                }
            }
        };

        return result;

    });


    $(document).ready(function($)
    {
        $('.filterfunctions .removefiltercontent').click(function (e)
        {
            e.stopPropagation();

            $(this).closest('th').find('input, select, textarea').each(function ()
            {
                $(this).val('').change();
            });
        });

        $('body').on('change', '.columns input, .columns select, .columns textarea', function (e)
        {
            if (! e.target.closest('div.datatablefilter'))
                return;

            // toggle class on the input itself
            e.target.classList.toggle('filter-filled', !!e.target.value);

            // find related table
            let table = e.target.closest('table');
            if (! table) return;

            // check if at least one filter is filled
            let hasActiveFilters = table.querySelectorAll('.filter-filled').length > 0;

            // toggle class on clear filters button(s) inside the same table container
            $(table)
                .closest('.dataTables_wrapper, .dt-container')
                .find('.clearfilters')
                .toggleClass('ib-has-active-filters', hasActiveFilters);
        });


        $('body').on('change keyup blur', '.sectionheader input, .sectionfooter input, .sectionheader select, .sectionfooter select', function (e) {

            var th = $(this).closest('th');

            var events = (th.data('filter-events') || 'keyup change').split(' ');

            // If user presses Enter, apply immediately
            if (e.type === 'keyup') {
                const code = e.keyCode || e.which;
                if (code === 13) {
                    // force execution even if keyup isn't in the list (but it usually is)
                    // we'll still respect the events check below
                }
            }

            const isEnter = (e.type === 'keyup') && ((e.keyCode || e.which) === 13);

            // se l’evento non è quello dichiarato, esci
            if (events.indexOf(e.type) === -1)
                return console.debug(e.type + ' non è un evento per filtrare su ' + th.data('label'));

            var colIndex = th.data('column');
            var tableId = $(this).closest('table').data('realid');
            var api = $('#' + tableId).DataTable();
            var column = api.column(colIndex);

            // tipo e eventi da data-*
            var type = $(this).data('filter-type') || 'text';

            // header/footer values
            if (th.data('range-filter') != 1)
            {
                var includeVal = column.getHeaderSingleValue();
                var excludeVal = column.getFooterSingleValue();

                // applica filtro combinato
                column.applyCombinedSearch(includeVal, excludeVal);
            }
            else
            {
                let key = tableId + '_rangeFilters';

                if(! window[key])
                    window[key] = {};

                if(! window[key][colIndex])
                    window[key][colIndex] = {};

                window[key][colIndex]['header'] = column.getHeaderRangeValues();

                if(! window[key][colIndex])
                    window[key][colIndex] = {};

                window[key][colIndex]['footer'] = column.getFooterRangeValues();
            }

            // Debounce draw to avoid filtering on every single keystroke
            if (isEnter) {
                api.draw();
            } else if (typeof column.launchDraw === 'function') {
                column.launchDraw();
            } else {
                api.draw();
            }
        });
    });

})();