(function registerIlBronzaDatatablesColumnVisibility() {
	if ($.fn.dataTable && $.fn.dataTable.Api) {


		$.fn.dataTable.Api.register('manageColumnVisibility()', function (columnName, visibility)
		{
			let dt = this;

			let table = this.getTableElement();
			let tableColumnDisplayRoute = table.data('columndisplayroute');

			let a = $('#togglefields' + table.attr('id')).find('[data-name="' + columnName + '"]');

			let action;

			if(visibility)
				action = 'showColumn';
			else
				action = 'hideColumn';

			var column = dt.column(a.data('column'));

			column.visible( visibility );

			if(visibility)
				$(a).data('visibility', 1).addClass('uk-text-bold');
			else
				$(a).data('visibility', 0).removeClass('uk-text-bold');

			$.ajax({
				url: tableColumnDisplayRoute,
				dataType: 'json',
				type: 'POST',
				data: {
					columnName: columnName,
					action: action
				},
				success: function(response)
				{
					if(! response.success == true)
						return this.error(response);

					if(visibility)
						window.addSuccessNotification('Colonna "' + a.text() + '" mostrata con successo');
					else
						window.addWarningNotification('Colonna "' + a.text() + '" nascosta con successo');

				},
				error: function (response)
				{
					window.addDangerNotification('Impossibile modificare la visualizzazione della colonna');
				}
			});
		});



		$(document).ready(function($)
		{
			$('a.toggle-vis').on('click', function (e)
			{
				var that = this;
				e.preventDefault();

				var dt = $('#' + $(that).parents('ul.toggle-vis-container').data('tableid')).DataTable();

				let columnName = $(that).data('name');
				let currentVisibility = $(that).data('visibility');

				return dt.manageColumnVisibility(columnName, ! currentVisibility);
			});

			$('.filterfunctions .hidecolumn').click(function (e)
			{
				e.stopPropagation();

				let th = $(this).parents('th');
				let columnName = th.data('name');

				var dt = $('#' + $(this).parents('table').data('realid')).DataTable();

				return dt.manageColumnVisibility(columnName, false);
			});

		});
	} else {
		// Riprova dopo un attimo
		setTimeout(registerIlBronzaDatatablesColumnVisibility, 100);
	}
})();