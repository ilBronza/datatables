(function registerIlBronzaDatatablesColumnVisibility() {
	if ($.fn.dataTable && $.fn.dataTable.Api) {


		$.fn.dataTable.Api.register('manageColumnVisibility()', function (columnName, visibility)
		{
			let dt = this;

			let table = this.getTableElement();
			let tableColumnDisplayRoute = table.data('columndisplayroute');

			let a = $('#togglefields' + table.attr('id')).find('[data-name="' + columnName + '"]');

			let action;

			if(visibility)
				action = 'showColumn';
			else
				action = 'hideColumn';

			var column = dt.column(a.data('column'));

			column.visible( visibility );

			if(visibility)
				$(a).data('visibility', 1).addClass('uk-text-bold');
			else
				$(a).data('visibility', 0).removeClass('uk-text-bold');

			$.ajax({
				url: tableColumnDisplayRoute,
				dataType: 'json',
				type: 'POST',
				data: {
					columnName: columnName,
					action: action
				},
				success: function(response)
				{
					if(! response.success == true)
						return this.error(response);

					if(visibility)
						window.addSuccessNotification('Colonna "' + a.text() + '" mostrata con successo');
					else
						window.addWarningNotification('Colonna "' + a.text() + '" nascosta con successo');

				},
				error: function (response)
				{
					window.addDangerNotification('Impossibile modificare la visualizzazione della colonna');
				}
			});
		});



		$(document).ready(function($)
		{
			$('a.toggle-vis').on('click', function (e)
			{
				var that = this;
				e.preventDefault();

				var dt = $('#' + $(that).parents('ul.toggle-vis-container').data('tableid')).DataTable();

				let columnName = $(that).data('name');
				let currentVisibility = $(that).data('visibility');

				return dt.manageColumnVisibility(columnName, ! currentVisibility);
			});

			// Column settings preview (styles) - selects column via gear and applies styles to real TDs
			if (! window.__ibColumnSettingsPreviewBound)
			{
				window.__ibColumnSettingsPreviewBound = true;

				window.columnIndexPreview = window.columnIndexPreview ?? 6;
				window.__ibColumnStyleDraft = window.__ibColumnStyleDraft || {};

				function normalizeCssValue(style, value)
				{
					if (style === 'fontSize' || style === 'letterSpacing')
						return value + 'px';

					return value;
				}

				function getDtFromToggleContainer(el)
				{
					const tableId = $(el).parents('ul.toggle-vis-container').data('tableid');
					if (! tableId)
						return null;

					return $('#' + tableId).DataTable();
				}

				function applyDraftToColumn(dt)
				{
					if (! dt)
						return;

					const nodes = dt.column(window.columnIndexPreview, { page: 'current' }).nodes();
					if (! nodes || ! nodes.length)
						return;

					$(nodes).each(function () {
						const td = this;
						Object.keys(window.__ibColumnStyleDraft).forEach(function (styleKey) {
							const raw = window.__ibColumnStyleDraft[styleKey];
							const v = normalizeCssValue(styleKey, raw);
							td.style[styleKey] = v;
						});
					});

					if (dt.columns && dt.columns.adjust)
						dt.columns.adjust();
				}

				function applyStyle(style, value, dt)
				{
					window.__ibColumnStyleDraft[style] = value;
					applyDraftToColumn(dt);
				}

				// Select column with gear
				$('body').on('click', 'a.ib-colvis-gear', function (e) {
					e.preventDefault();
					e.stopPropagation();

					const toggle = this.parentElement.querySelector('a.toggle-vis');
					const col = toggle ? toggle.dataset.column : null;
					if (col !== null && col !== undefined)
						window.columnIndexPreview = parseInt(col, 10);

					const dt = getDtFromToggleContainer(this);
					applyDraftToColumn(dt);
				});

				// Bind style inputs (live preview). Works globally since the form lives in DOM.
				$('body').on('input change', '.colvis-settings-form .ib-style', function () {
					const style = this.dataset.style;
					if (! style)
						return;

					// Use the first toggle-vis container (same approach as toggle handler)
					const dt = $('#' + $('ul.toggle-vis-container').first().data('tableid')).DataTable();
					applyStyle(style, this.value, dt);
				});
			}

			$('.filterfunctions .hidecolumn').click(function (e)
			{
				e.stopPropagation();

				let th = $(this).parents('th');
				let columnName = th.data('name');

				var dt = $('#' + $(this).parents('table').data('realid')).DataTable();

				return dt.manageColumnVisibility(columnName, false);
			});

		});
	} else {
		// Riprova dopo un attimo
		setTimeout(registerIlBronzaDatatablesColumnVisibility, 100);
	}
})();