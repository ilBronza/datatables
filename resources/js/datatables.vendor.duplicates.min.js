(function registerIlBronzaDatatablesDuplicates() {
    if ($.fn.dataTable && $.fn.dataTable.Api) {
        $.fn.dataTable.Api.register('hasDuplicatesActive()', function (table = null)
        {
            if(! table)
                table = this.getTableElement();

            return this.getDataAttribute('doubler', table);
        });

        $.fn.dataTable.Api.register('toggleShowDuplicates()', function (table = null)
        {
            if(! table)
                table = this.getTableElement();

            if(typeof table.data('showDuplicates') === 'undefined')
                return table.data('showDuplicates', true);

            table.data('showDuplicates', ! table.data('showDuplicates'));
        });

        // Debounced duplicates runner (shared)
        if(! window.__ibDebouncedShowTableDuplicates)
        {
            window.__ibDebouncedShowTableDuplicates = {};
        }

        window.__showTableDuplicates = function(table)
        {
            let _table = table.table().node();
            let tableKey = $(_table).attr('id') || _table;

            if(! window.__ibDebouncedShowTableDuplicates[tableKey])
            {
                window.__ibDebouncedShowTableDuplicates[tableKey] = (function () {
                    let timeout = null;

                    return function (tbl) {
                        clearTimeout(timeout);
                        timeout = setTimeout(function () {

                            console.log('Showing duplicates (debounced)');
                            let _t = tbl.table().node();

                            $(_t).find('th.doubler').each(function ()
                            {
                                var columnIndex = $(this).data('column');
                                var columnName = $(this).data('camelname');
                                var names = window.__getTableArrayNames(tbl, columnIndex);
                                window.__showDuplicates(tbl, names, columnIndex, columnName);
                            });

                        }, 200); // debounce delay
                    };
                })();
            }

            window.__ibDebouncedShowTableDuplicates[tableKey](table);
        }

        window.__showDuplicates = function(datatable, names, columnIndex, columnName)
        {
            // Clear previous highlights on the currently visible page
            var tableNode = datatable.table().node();
            $(tableNode).find('td.doubled').removeClass('doubled');
            $(tableNode).find('tr[class*="double"]').each(function () {
                $(this).removeClass('double' + columnName);
            });

            // Apply only to rows currently in the DOM (visible page)
            datatable.rows({ page: 'current' }).every(function ()
            {
                var rowIdx = this.index();
                var nameCell = datatable.cell(rowIdx, columnIndex);
                var raw = String(nameCell.data() || '');

                // Split comma-separated values and normalize
                raw.split(',').forEach(function (value)
                {
                    var name = value.trim();
                    if(! name.length)
                        return;

                    if(names[name] > 1)
                    {
                        $(nameCell.node()).addClass('doubled');
                        $(nameCell.node()).closest('tr').addClass('double' + columnName);
                    }
                });
            });
        }

        window.__getTableArrayNames = function(datatable, columnIndex, dataIndex = null)
        {
            let names = {};

            datatable.rows().eq( 0 ).map(function (rowIdx)
            {
                var cell = datatable.cell(rowIdx, columnIndex);
                var raw = String(cell.data() || '');

                // Split comma-separated values and normalize
                raw.split(',').forEach(function (value)
                {
                    var name = value.trim();
                    if(! name.length)
                        return;

                    if(typeof names[name] === 'undefined')
                        names[name] = 0;

                    names[name] += 1;
                });
            });

            return names;
        }
    } else {
        // Riprova dopo un attimo
        setTimeout(registerIlBronzaDatatablesDuplicates, 100);
    }
})();