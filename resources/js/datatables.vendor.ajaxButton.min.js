
$(window).on("beforeunload", function() {
    try {
        if (window.__ibDtDirtyCount) {
            for (const k in window.__ibDtDirtyCount) {
                if (window.__ibDtDirtyCount[k] > 0)
                    return confirm("Do you really want to close?");
            }
        }
    } catch (e) {}

    // fallback (se qualcosa va storto)
    if ($('.editorchanged').length > 0)
        return confirm("Do you really want to close?");
});

window.setContainerCanSendData = function (target, value)
{
    if ($(target).parent().prop('tagName') == 'TD')
        $(target).closest('tr').addClass('editorcansave');
}

window.setSendSendableEditorFields = function(target)
{
    if ($(target).parent().prop('tagName') == 'TD')
        $(target).closest('tr').find('.editorchanged').each(function()
        {
            // $(this).trigger('blur');

            $(this).trigger('ib:dt-editor-save', {source: 'row-save-button'});
        });
}

window.editorFieldHasChanged = function (target)
{
    var val = $(target).val();
    var oldVal = $(target).data('originalvalue');

    if ((val === '') && (oldVal === 0))
        return true;

    return oldVal != val;
};

window.fieldHasUpdateOnSave = function(target)
{
    var th = window.__getTH(target);

    return $(th).data('editorsavebutton');
}

window.fieldCanSendData = function (target)
{
    if(! window.fieldHasUpdateOnSave(target))
        return true;

    if ($(target).parent().prop('tagName') == 'TD')
        return $(target).closest('tr').hasClass('editorcansave');
}

window.manageEditorFieldSavingPermission = function (target)
{
    if (window.fieldCanSendData(target) == true)
        return true;

    $(target).addClass('editorchanged');
    $(target).closest('tr').addClass('editorchangedrow');

    return false;
};

window.__mustRedirectSubmit = function (target) {
    if ($(target).data('redirectsubmit')) return true;
    return false;
};

window.__mustSubmit = function (target)
{
    if ($(target).data('redirectsubmit') === false)
        return true;

    return false;
};

window.__getDTTableHeaderFilters = function (target)
{
    let filters = {};

    let table = $('#' + target).find('.sectionheader');

    let filterInputs = table.find('input');

    filterInputs.each(function ()
    {
        let name = $(this).attr('name');
        let value = $(this).val();

        // if (value != '')
        filters[name] = value;
    });

    return filters;
}

$(document).ready(function($)
{
    $('body').on('keydown', '.ib-editor-text', function (e) {

        if (e.key !== 'ArrowLeft' && e.key !== 'ArrowRight')
            return;

        // If the browser can't report selection, default to "edit inside"
        if (typeof this.selectionStart !== 'number' || typeof this.selectionEnd !== 'number') {
            e.stopPropagation();
            return;
        }

        const len = (this.value || '').length;
        const allSelected = (this.selectionStart === 0 && this.selectionEnd === len);

        if (allSelected) {
            // We are in "cell navigation mode":
            // keep selection intact, let KeyTable handle the arrow
            e.preventDefault();   // don't collapse selection / move caret
            return;               // allow bubbling -> KeyTable sees it
        }

        // We are in "text edit mode":
        // let the caret move, but block KeyTable from moving the cell
        e.stopPropagation();
    });

    $('body').on('click', '.ib-editor-save', function (e)
    {
        window.setContainerCanSendData(this, true);
        window.setSendSendableEditorFields(this, true);
    });

    // Per-table save button toggle + click handler
    window.__ibGetTableDomIdByEditor = function (target)
    {
        const $table = $(target).closest('table');
        return $table.attr('id');
    };

    // Dirty registry: NOT derived from live DOM
    window.__ibDtDirtyCount = window.__ibDtDirtyCount || {}; // tableDomId => int

    // Normalize button base labels once (strip existing trailing " (n)" if present)
    window.__ibNormalizeSaveButtonBaseLabel = function (tableDomId)
    {
        const $btn = $('#ib-save-dt-inputs-' + tableDomId);
        if (!$btn.length) return;

        if ($btn.data('base-label')) return;

        const t = ($btn.text() || '').trim();
        const base = t.replace(/\s*\(\d+\)\s*$/, '');
        $btn.data('base-label', base);
    };

    window.__ibGetDirtyCount = function (tableDomId)
    {
        return (window.__ibDtDirtyCount[tableDomId] || 0);
    };

    window.__ibSetDirtyCount = function (tableDomId, value)
    {
        window.__ibDtDirtyCount[tableDomId] = Math.max(0, parseInt(value || 0, 10));
        return window.__ibDtDirtyCount[tableDomId];
    };

    window.__ibIncDirty = function (tableDomId)
    {
        return window.__ibSetDirtyCount(tableDomId, window.__ibGetDirtyCount(tableDomId) + 1);
    };

    window.__ibDecDirty = function (tableDomId)
    {
        return window.__ibSetDirtyCount(tableDomId, window.__ibGetDirtyCount(tableDomId) - 1);
    };

// mark dirty only once per field
    window.__ibMarkFieldDirtyOnce = function (target)
    {
        const tableDomId = window.__ibGetTableDomIdByEditor(target);
        if (!tableDomId) return;

        const $el = $(target);
        if ($el.data('ibDirtyTracked') === true) return;

        $el.data('ibDirtyTracked', true);
        window.__ibIncDirty(tableDomId);
    };

// unmark dirty (after save/reset) and decrement
    window.__ibUnmarkFieldDirty = function (target)
    {
        const tableDomId = window.__ibGetTableDomIdByEditor(target);
        if (!tableDomId) return;

        const $el = $(target);
        if ($el.data('ibDirtyTracked') !== true) return;

        $el.data('ibDirtyTracked', false);
        window.__ibDecDirty(tableDomId);
    };

// Optional: if button label shows a counter
    window.__ibUpdatePerTableSaveButtonLabel = function (tableDomId)
    {
        const $btn = $('#ib-save-dt-inputs-' + tableDomId);
        if (!$btn.length) return;

        window.__ibNormalizeSaveButtonBaseLabel(tableDomId);
        const base = $btn.data('base-label') || $btn.text();

        const count = window.__ibGetDirtyCount(tableDomId);
        $btn.text(count > 0 ? (base + ' (' + count + ')') : base);
    };

    window.__ibTogglePerTableSaveButton = function (target)
    {
        const tableDomId = window.__ibGetTableDomIdByEditor(target);
        if (!tableDomId) return;

        const $btn = $('#ib-save-dt-inputs-' + tableDomId);
        if (!$btn.length) return;

        const hasDirty = window.__ibGetDirtyCount(tableDomId) > 0;
        $btn.toggleClass('uk-hidden', !hasDirty);
        window.__ibUpdatePerTableSaveButtonLabel(tableDomId);
    };

    // Click: save all dirty editor fields for that table
    $('body').on('click', '[id^="ib-save-dt-inputs-"]', function (e)
    {
        e.preventDefault();
        e.stopPropagation();

        // Mark rows as sendable for “save on button” columns
        const btnId = $(this).attr('id') || '';
        const tableDomId = btnId.replace('ib-save-dt-inputs-', '');

        if (! tableDomId)
            return false;

        const $table = $('#' + tableDomId);
        if (! $table.length)
            return false;

        // Allow sending data for columns that require an explicit save button
        $table.find('.editorchanged').each(function ()
        {
            window.setContainerCanSendData(this, true);
        });

        // Fire centralized save event for each dirty field
        // Trigger centralized save event for each dirty field in this table
        $table.find('.editorchanged').each(function ()
        {
            $(this).trigger('ib:dt-editor-save', {source: 'table-save-button'});
        });

        // Will hide once markers are cleared
        // Recompute visibility
        window.__ibTogglePerTableSaveButton($table[0]);

        return false;
    });

    // Prevent losing unsaved inline-editor inputs on DT state changes (page/filter/order/length)
    window.__ibDtStableState = window.__ibDtStableState || {};      // keyed by tableDomId
    window.__ibDtReverting = window.__ibDtReverting || {};          // keyed by tableDomId
    window.__ibDtBound = window.__ibDtBound || {};                // keyed by tableDomId
    window.__ibDtPrompting = window.__ibDtPrompting || {};        // keyed by tableDomId

    window.__ibGetTableDomIdFromSettings = function (settings)
    {
        try {
            const table = settings && settings.nTable ? settings.nTable : null;
            if (! table)
                return null;

            return $(table).attr('id');
        } catch (err) {
            return null;
        }
    };

    window.__ibCaptureDtState = function (dt)
    {
        try {
            const info = dt.page && dt.page.info ? dt.page.info() : null;
            return {
                page: info ? info.page : 0,
                len: dt.page && dt.page.len ? dt.page.len() : 10,
                order: dt.order ? dt.order() : [],
                search: dt.search ? dt.search() : ''
            };
        } catch (err) {
            return null;
        }
    };

    window.__ibRestoreDtState = function (dt, state)
    {
        if (! state)
            return;

        try {
            if (dt.page && dt.page.len)
                dt.page.len(state.len);

            if (dt.search)
                dt.search(state.search);

            if (dt.order)
                dt.order(state.order);

            if (dt.page)
                dt.page(state.page);

            dt.draw(false);
        } catch (err) {
            // no-op
        }
    };

    window.__ibTableHasDirtyEditors = function (tableDomId)
    {
        if (! tableDomId)
            return false;

        const $table = $('#' + tableDomId);
        if (! $table.length)
            return false;

        return $table.find('.editorchanged').length > 0;
    };

    // Keep a “last stable” DT state snapshot
    window.__ibGetDtSettingsFromEvent = function (e, settings)
    {
        if (settings)
            return settings;

        try {
            let table = e && e.target ? e.target : null;
            if (! table)
                return null;

            if (table.tagName !== 'TABLE')
                table = $(table).closest('table')[0];

            if (! table)
                return null;

            if ($.fn.dataTable && $.fn.dataTable.settings)
            {
                for (let i = 0; i < $.fn.dataTable.settings.length; i++)
                {
                    if ($.fn.dataTable.settings[i].nTable === table)
                        return $.fn.dataTable.settings[i];
                }
            }
        } catch (err) {}

        return null;
    };

    window.__ibUpdateStableDtState = function (tableDomId)
    {
        if (!tableDomId)
            return;

        if (window.__ibDtReverting[tableDomId])
            return;

        try
        {
            const dt = $('#' + tableDomId).DataTable();
            window.__ibDtStableState[tableDomId] = window.__ibCaptureDtState(dt);
        } catch (err)
        {
            // no-op
        }
    }

    // Guard: ask confirmation when changing page/filter/order/length with pending edits
    window.__ibGuardDtStateChange = function (tableDomId)
    {
        // Prevent multiple prompts fired by KeyTable/DT event cascades
        if (window.__ibDtPrompting[tableDomId])
            return;

        window.__ibDtPrompting[tableDomId] = true;
        setTimeout(function () {
            window.__ibDtPrompting[tableDomId] = false;
        }, 0);

        if (! tableDomId)
            return;

        if (window.__ibDtReverting[tableDomId])
            return;

        // Only warn if this table has pending edits
        if (! window.__ibTableHasDirtyEditors(tableDomId))
        {
            window.__ibUpdateStableDtState(tableDomId);

            return;
        }

        const proceed = confirm('You have unsaved changes in this table. If you continue, you may lose them. Do you want to proceed?');
        if (proceed)
        {
            // Accept new state as stable
            window.__ibUpdateStableDtState(tableDomId);

            return;
        }

        // Revert to last stable state
        const stable = window.__ibDtStableState[tableDomId];
        if (! stable)
            return;

        window.__ibDtReverting[tableDomId] = true;

        try {
            const dt = $('#' + tableDomId).DataTable();
            window.__ibRestoreDtState(dt, stable);
        } catch (err) {
            // no-op
        }

        setTimeout(function () {
            window.__ibDtReverting[tableDomId] = false;
        }, 0);

    };

    // Bind DT lifecycle handlers reliably (directly on each initialized table)
    $(document).on('init.dt', function (e, settings)
    {
        const s = window.__ibGetDtSettingsFromEvent(e, settings);
        if (! s)
            return;

        const tableDomId = window.__ibGetTableDomIdFromSettings(s);
        if (! tableDomId)
            return;

        const $table = $('#' + tableDomId);
        if (! $table.length)
            return;

        if (window.__ibDtBound[tableDomId])
            return;

        window.__ibDtBound[tableDomId] = true;

        // Initial stable snapshot
        window.__ibUpdateStableDtState(tableDomId);

        // Keep stable snapshot updated on draw (when not reverting)
        $table.on('draw.dt', function () {
            window.__ibUpdateStableDtState(tableDomId);
        });

        // Guard state-changing events
        $table.on('page.dt length.dt order.dt search.dt', function () {
            window.__ibGuardDtStateChange(tableDomId);
        });
    });


    // $('body').on('click', '.datatable td a', function (e)
    // {
    //     if (! __isHeaderConfirmed(e))
    //         return false;
    // });

$(document).on(
    'click',
    'td [uk-lightbox] a',
    function (e) {
        e.preventDefault();

        let lightbox = UIkit.lightbox(this.closest('[uk-lightbox]') ?? this);
        lightbox.show(this);
    }
);

    $('body').on('click', '.ib-table-form-action-button', function (e)
    {
        e.preventDefault();

        var th = window.__getTH(this);

        let formId = th.data('form-id');
        let url = $(this).attr('href');

        $('#' + formId).attr('action', url);
        $('#' + formId).submit();
    });

    $('body').on('click', '.ib-table-action-button', function(e)
    {
        e.preventDefault();

        var target = this;

        if(window.__mustOpenIframe(target))
            return window.__openIframe(target);

        if(window.__mustRedirectSubmit(target))
            return window.__redirectSubmit(target);

        if (window.__mustSubmit(target)) return window.__submitDatatable(target);

        console.log('Assolutamente rimuovere queste righe successive legate ad un modal di idealpack');
        var modal = $('#deliveries-modal');
        if(modal.length)
        {
            alert('qua controllare sta cagata');
            UIkit.modal(modal).hide();
        }

        var tableid = $(this).data('tableid');
        var table = $('#' + tableid).DataTable();

        let idColumnIndex = window.__getIdColumnIndex(this, table);

        let selectedRows = table.rows( { selected: true } );
        var ids = selectedRows.data().pluck(idColumnIndex).toArray();

        var url = $(this).data('route');

        // window.open(url + '?iframed=true&callertablename=' + tableVarName, 'window', 'width=960, height=600, toolbar=no, menubar=no, resizable=yes');

        // openWindowWithPost(url, {
        //     ids: ids,
        // });


        // return false;

        $.ajax({
            url : url,
            type : 'POST',
            data : {
                ids : ids
            },
            success : function (response)
            {
                if(response.success == false)
                    return this.error(response);

                // if(typeof response.notReload === 'undefined')
                //     table.ajax.reload();

                if(response.success == true)
                    window.addSuccessNotification(response.message);

                if (response.ibaction == 'redirect') window.location.href = response.href;

                if((typeof response.action !== 'undefined'))
                {
                    if(response.action == 'reloadTable')
                    {
                        table.rows().deselect();
                        window.reloadDatatable(table);
                    }

                    else if(response.action == 'reload')
                        location.reload();

                    else if(response.action == 'redirect')
                        window.location.href = response.route;

                    if(response.action == 'remove')
                    {
                        response.ids.forEach(function(value)
                        {
                            table.row("#" + value).remove();
                        });
                        
                        table.draw();
                    }
                }

                window.__checkResultPopup(response, {
                    target: target
                });

                window.__displayResponseErrors(response);
            },
            error: function (response)
            {
                window.reloadDatatable(table);
                table.draw();

                window.__displayResponseErrors(response);
            }
        });
    });


    $('body').on('click', '.ib-toggle', function(e)
    {
        let th = window.__getTH(e.target);

        let value = $(this).data('value');

        if(value === '')
            value = true;
        else if((value === 1)||(value === "true")||(value === true))
            value = false;
        else if((value === 0)||(value === "false")||(value === false))
        {
            if($(th).data('nullable'))
                value = null;
            else
                value = true;
        }

        var params = {
            target: this,
            e: e,
            type: 'POST',

            data: {
                "ib-editor": true,
                field: $(this).data('field'),
                value: value,
                _method: 'PUT'
            }

            // data: {
            // "ib-editor": true,
            // toggle: true,
            // field: $(this).data('field'),
            // _method: 'PUT'
            // }
        };

        window.ibCallAjax(params);
    });

    $('body').on('click', '.ib-ajax', function(e)
    {
        let data = $(this).data();

        data['ib-editor'] = true;
        data._method = 'PUT';

        var params = {
            target : this,
            e : e,
            type : 'POST',
            data : data
        };

        window.ibCallAjax(params);
    });

    $('body').on('focus', '.ib-editor-color', function(e)
    {
        $(target).data('originalvalue', $(target).val());
    });

    $('body').on('blur', '.ib-editor-color', function(e)
    {
        if(! window.editorFieldHasChanged(this))
            return false;

        if (!window.manageEditorFieldSavingPermission(this))
            return false;

        var params = {
            target : this,
            e : e,
            type : 'POST',
            data : {
                "ib-editor" : true,
                field : $(this).data('field'),
                value : $(this).val(),
                _method : 'PUT',
            }
        };

        window.ibCallAjax(params);
    });


    // $('body').on('keyup', '.ib-editor-text', function(e)
    // {
        // var code = e.keyCode || e.which;

        // if(code == 13)
        // {
        //     let table = window.__getTableByCell(this);
        //     let datatable = table.DataTable();
        //     datatable.keys.enable();

        //     return;
        // }

        // let table = window.__getTableByCell(this);
        // let datatable = table.DataTable();
        // datatable.keys.disable();
    // });


    // Dedicated editor save event (single place where the ajax call is fired)
    $('body').on('ib:dt-editor-save', '.ib-editor-text', function(e, meta)
    {
        if(! window.editorFieldHasChanged(this))
            return false;

        if (!window.manageEditorFieldSavingPermission(this))
            return false;

        var params = {
            target : this,
            e : e,
            type : 'POST',
            data : {
                "ib-editor" : true,
                field : $(this).data('field'),
                value : $(this).val(),
                _method : 'PUT',
            }
        };

        $(this).removeData('cleaveInstance');

// Optimistically clear dirty markers (server errors handled by existing error UI)
        const $tr = $(this).closest('tr');

        if ($tr.find('.editorchanged').length === 0)
            $tr.removeClass('editorchangedrow');

        $(this).removeClass('ib-editor-dirty editorchanged');
        window.__ibUnmarkFieldDirty(this);

        // Update original value after save (for Enter-triggered save alignment)
        $(this).data('originalvalue', $(this).val());



        window.__ibTogglePerTableSaveButton(this);
        window.ibCallAjax(params);
    });

    // Save on Enter (more reliable than blur)
    $('body').on('keydown', '.ib-editor-text', function(e)
    {
        if (e.key !== 'Enter')
            return;

        if (typeof this.selectionStart === 'number' && typeof this.selectionEnd === 'number')
        {
            const len = (this.value || '').length;

            // const allSelected = (this.selectionStart === 0 && this.selectionEnd === len);
            const allSelected = (len > 0 && this.selectionStart === 0 && this.selectionEnd === len);

            if (allSelected)
            {
                // Enter while fully selected: switch to editing mode (caret), keep focus on input
                e.preventDefault();
                e.stopPropagation();

                const el = this;

                setTimeout(function () {
                    try {
                        el.focus();

                        if (typeof el.setSelectionRange === 'function') {
                            const pos = (el.value || '').length;   // caret at end (scegli 0 se lo vuoi all’inizio)
                            el.setSelectionRange(pos, pos);
                        }
                    } catch (err) {}
                }, 0);

                return;
            }
        }

        // Normal Enter: save
        e.preventDefault();
        e.stopPropagation();

        $(this).trigger('ib:dt-editor-save', {source: 'enter'});
    });

    $('body').on('keydown', '.ib-editor-text', function(e)
    {
        if (e.key !== 'Escape')
            return;

        e.preventDefault();
        e.stopPropagation();

        const $el = $(this);
        const original = $el.data('originalvalue');

        $el.val(original);

        $el.removeClass('ib-editor-dirty editorchanged');
        window.__ibUnmarkFieldDirty(this);

        const $tr = $el.closest('tr');
        if ($tr.find('.editorchanged').length === 0)
            $tr.removeClass('editorchangedrow');

        if (typeof this.select === 'function')
            this.select();

        window.__ibTogglePerTableSaveButton(this);

        return true;
    });

    $('body').on('click', '.ib-editor-select', function(e)
    {
        if($(this).data('populated'))
            return ;

        if($(this).data('populating'))
            return ;


        $(this).data('populating', true);

        let currentValue = $(this).val();

        let th = window.__getTH(this);
        let possibleValues = th.data('possiblevalues');

        for (var key in possibleValues)
        {
            if(key == currentValue)
                continue;

            $(this).append('<option value="' + key + '">' + possibleValues[key] + '</option>');
        }

        $(this).data('populated', true);
        $(this).data('populating', false);
    });

    // Mark editor fields as "dirty" while typing (visual highlight)
    $('body').on('input change', '.ib-editor-text', function(e)
    {
        const $el = $(this);
        const current = $el.val();
        const original = $el.data('originalvalue');

        // Same semantics as editorFieldHasChanged (keep 0 vs '' special case)
        let changed;

        if ((current === '') && (original === 0))
            changed = true;
        else
            changed = (original != current);

        $el.toggleClass('ib-editor-dirty', !!changed);

        // Keep existing row-level markers compatible with your save button logic
        if (changed)
        {
            $el.addClass('editorchanged');
            window.__ibMarkFieldDirtyOnce(this);
        }
        else
        {
            $el.removeClass('editorchanged');
            window.__ibUnmarkFieldDirty(this);
        }

        window.__ibTogglePerTableSaveButton(this);

        return true;
    });



    $('body').on('change', '.ib-editor-select', function(e)
    {
        if (!window.editorFieldHasChanged(this))
            return false;

        if (!window.manageEditorFieldSavingPermission(this))
            return false;

        let value = $(this).val();

        if(value == 'null')
            value = null;

        if (value == $(this).data('originalvalue')) return false;
        var params = {
            target: this,
            e: e,
            type: 'POST',
            data: {
                "ib-editor": true,
                field: $(this).data('field'),
                value: value,
                _method: 'PUT'
            }
        };
        window.ibCallAjax(params);
    });

    $('body').on('click', '.ib-cell-ajax-button', function(e)
    {
        e.preventDefault();

        let sendingData = {};

        // var data = $(this).data('datas');

        // if($(this).data('dataattributes'))
        //     data = collectDataAttributes(this);

        // else if($(this).data('elements'))
        //     data = collectDatas(this);

        // if($(this).data('dataattributes'))
        //     var sendingData = data;
        // else
        //     var sendingData = {data : data};

        if($(this).data('method'))
            sendingData._method = $(this).data('method');

        var params = {
            target : this,
            e : e,
            data : sendingData
        };

        window.ibCallAjax(params);
    });
});
