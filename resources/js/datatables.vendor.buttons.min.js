(function registerilBronzaDatatablesButtons() {
    if ($.fn.dataTable && $.fn.dataTable.Api) {

        $.fn.dataTable.Api.register( 'activateButton()', function (button, activate = true)
{
    if(activate)
        return $(button).addClass('uk-button-primary');

    return $(button).removeClass('uk-button-primary');
} );

$.fn.dataTable.Api.register( 'deactivateButton()', function (button)
{
    return this.activateButton(button, false);
});

$.fn.dataTable.ext.buttons.fieldsVisibility = {
    text: window.fieldsVisibilityString,
  action: function action(e, dt, node, config) {
    let id = $(node).parents('.dt-container').find('table').data('realid');
    $('#offcanvastogglefieldsbutton' + id).click();
  }
};

$.fn.dataTable.ext.buttons.search = {
    text: 'Apply search',
    action: function ( e, dt, node, config ) {
        dt.draw();
    }
};

$.fn.dataTable.ext.buttons.reload = {
    text: 'Reload',
    action: function ( e, dt, node, config ) {
        // native DataTables reload (triggers processing spinner)
        dt.ajax.reload(null, false);
    }
};

$.fn.dataTable.ext.buttons.selectedRows =
{
    extend: 'selected',
    text: '<i uk-tooltip="Solo selezionate" class="fa-solid fa-eye"></i>',
    action: function ( e, dt, node, config )
    {
        const tableNode = dt.table().node();

        // salva il pageLength originale solo la prima volta
        if (typeof tableNode.__originalPageLength === 'undefined') {
            tableNode.__originalPageLength = dt.page.len();
        }

        dt.toggleShowSelected();

        let showSelected = dt.getDataAttribute('showSelected');

        dt.activateButton(node, showSelected);

        if (showSelected)
        {
            // conta quante righe sono selezionate
            const selectedCount = dt.rows({ selected: true }).count();

            // preset disponibili di DataTables (es: [10,25,50,100,250,500,-1])
            const lengthMenu = dt.settings()[0].aLengthMenu[0];

            // scegli il primo preset >= selectedCount
            let targetLength = lengthMenu.find(len => len !== -1 && len >= selectedCount);

            // fallback: se nessun preset basta, usa il più grande (escludendo -1)
            if (typeof targetLength === 'undefined') {
                targetLength = Math.max(...lengthMenu.filter(len => len !== -1));
            }

            // applica nuova paginazione solo se diversa
            if (dt.page.len() !== targetLength) {
                dt.page.len(targetLength).draw(false);
            }

            // nasconde le non selezionate
            dt.rows({ selected: false }).nodes().to$().css({ display: 'none' });
            dt.rows({ selected: true }).nodes().to$().css({ display: 'table-row' });
        }
        else
        {
            // ripristina visibilità
            dt.rows().nodes().to$().css({ display: 'table-row' });

            // ripristina pageLength originale
            if (dt.page.len() !== tableNode.__originalPageLength) {
                dt.page.len(tableNode.__originalPageLength).draw(false);
            }
        }
    }
};

// $.fn.dataTable.ext.buttons.doubler =
// {
//     text: 'Mostra duplicati',
//     action: function ( e, dt, node, config )
//     {
//         dt.toggleShowDuplicates();
//
//         let showDuplicates = dt.getDataAttribute('showDuplicates');
//
//         dt.activateButton(node, showDuplicates);
//
//         if(showDuplicates)
//             window.__showTableDuplicates(dt);
//     }
// };

$.fn.dataTable.ext.buttons.removeSummary = {
    text: 'Riepilogo',
    action: function ( e, dt, node, config ) {

        $(node).toggleClass('uk-button-danger');

        const table = dt.table().node();
        table.__summaryActive = !table.__summaryActive;

        // Force immediate summary calculation on activation
        if (table.__summaryActive === true) {
            dt.draw(false);
        }

        $(node).parents('.dt-container').find('tr.summary').toggle();
        $(node).parents('.dt-container').find('tr.inlinesearchsummary').toggle();
    }
};

$.extend(true, $.fn.dataTable.ext.classes, {
    paging: {
        button: 'uk-button uk-button-small ib-dt-paging-button',
    }
});

    } else {
        // Riprova dopo un attimo
        setTimeout(registerilBronzaDatatablesButtons, 100);
    }
})();
